name: CI - Test, Build and Publish Docker image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  issues: write

jobs:
  security-scan:
    uses: ./.github/workflows/security.yml

  build-and-push:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        # Ensure the repository root is on PYTHONPATH so `from main import app` works
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q

      - name: Security gate decision
        id: security-gate
        run: |
          ALLOW_PUSH=true
          if [ "${BANDIT_EXIT:-0}" = "1" ]; then
            ALLOW_PUSH=false
          fi
          if [ "${PIPAUDIT_EXIT:-0}" = "1" ]; then
            ALLOW_PUSH=false
          fi
          if ! grep -q "No issues found" reports/trivy.txt && ! grep -q "Total: 0" reports/trivy.txt; then
            ALLOW_PUSH=false
          fi
          echo "allow_push=$ALLOW_PUSH" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect container changes
        id: changes
        run: |
          # For workflow_dispatch, default to pushing
          if [ -z "${{ github.event.before }}" ]; then
            echo "should_push=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          BEFORE_SHA="${{ github.event.before }}"
          # If BEFORE_SHA isn't available in the local clone, fall back to previous commit
          if ! git cat-file -e "$BEFORE_SHA^{commit}" 2>/dev/null; then
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              BEFORE_SHA=$(git rev-parse HEAD~1)
            else
              echo "should_push=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          CHANGED=$(git diff --name-only "$BEFORE_SHA" ${{ github.sha }})
          echo "Changed files:"; echo "$CHANGED"

          SHOULD_PUSH=false
          for f in $CHANGED; do
            case "$f" in
              Dockerfile|requirements.txt|main.py|tests/*|ansible/*|terraform/*)
                SHOULD_PUSH=true
                break
                ;;
            esac
          done

          echo "should_push=$SHOULD_PUSH" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: ${{ steps.changes.outputs.should_push == 'true' && needs.security-scan.outputs.allow_push == 'true' }}
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          platforms: linux/amd64
